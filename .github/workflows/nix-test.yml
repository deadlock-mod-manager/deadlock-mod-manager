name: Test Nix Build

on:
  pull_request:
    branches: [main]
    paths:
      - "flake.nix"
      - "flake.lock"
      - "apps/desktop/**"
      - "packages/**"
      - ".github/workflows/nix-test.yml"
  push:
    branches: [main]
    paths:
      - "flake.nix"
      - "flake.lock"
      - "apps/desktop/**"
      - "packages/**"
      - ".github/workflows/nix-test.yml"
  workflow_dispatch:

jobs:
  check-flake:
    name: Check Flake
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: deadlock-mod-manager
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Check flake
        run: nix flake check --all-systems --show-trace

      - name: Show flake metadata
        run: nix flake metadata

  build-nightly:
    name: Build Nightly Package
    runs-on: ubuntu-latest
    needs: check-flake
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: deadlock-mod-manager
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Build nightly package
        run: |
          nix build .#nightly --print-build-logs

      - name: Check binary
        run: |
          nix run .#nightly -- --version || true
          nix path-info .#nightly

      - name: Show package info
        run: |
          nix eval .#nightly.meta.description --json
          nix eval .#nightly.version --json || echo "Version info not available"

  build-dev-shell:
    name: Test Development Shell
    runs-on: ubuntu-latest
    needs: check-flake
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: deadlock-mod-manager
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Build development shell
        run: |
          nix develop --command echo "Development shell loaded successfully"

      - name: Check dev tools availability
        run: |
          nix develop --command bash -c "
            echo 'Checking Rust toolchain...'
            rustc --version
            cargo --version
            
            echo 'Checking Node.js tools...'
            node --version
            pnpm --version
            bun --version
            
            echo 'Checking development tools...'
            biome --version || echo 'biome not in PATH'
            turbo --version
          "

  update-hashes:
    name: Update Dependency Hashes
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build-nightly
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Check if hashes need updating
        id: check-hashes
        continue-on-error: true
        run: |
          # Try to build and capture hash mismatch errors
          nix build .#nightly --print-build-logs 2>&1 | tee build.log || true
          
          if grep -q "hash mismatch" build.log; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Hash mismatch detected - updating hashes"
            
            # Extract the expected hashes from error messages
            CARGO_HASH=$(grep -A5 "cargoHash" build.log | grep "got:" | sed 's/.*got: *\(sha256-[^ ]*\).*/\1/' || echo "")
            PNPM_HASH=$(grep -A5 "pnpmDeps" build.log | grep "got:" | sed 's/.*got: *\(sha256-[^ ]*\).*/\1/' || echo "")
            
            echo "cargo_hash=$CARGO_HASH" >> $GITHUB_OUTPUT
            echo "pnpm_hash=$PNPM_HASH" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update hashes in flake.nix
        if: steps.check-hashes.outputs.needs_update == 'true'
        run: |
          CARGO_HASH="${{ steps.check-hashes.outputs.cargo_hash }}"
          PNPM_HASH="${{ steps.check-hashes.outputs.pnpm_hash }}"
          
          if [ -n "$CARGO_HASH" ]; then
            echo "Updating cargoHash to: $CARGO_HASH"
            sed -i "s|cargoHash = \"sha256-[^\"]*\";|cargoHash = \"$CARGO_HASH\";|g" flake.nix
          fi
          
          if [ -n "$PNPM_HASH" ]; then
            echo "Updating pnpmHash to: $PNPM_HASH"
            sed -i "s|pnpmHash = \"sha256-[^\"]*\";|pnpmHash = \"$PNPM_HASH\";|g" flake.nix
          fi
          
          echo "Updated flake.nix:"
          grep -A2 "cargoHash\|pnpmHash" flake.nix

      - name: Commit and push updated hashes
        if: steps.check-hashes.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add flake.nix
          git commit -m "chore(nix): update dependency hashes [skip ci]" || exit 0
          git push
