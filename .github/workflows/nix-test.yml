name: Test Nix Build

on:
  pull_request:
    branches: [main]
    paths:
      - "flake.nix"
      - "flake.lock"
      - "package.nix"
      - "apps/desktop/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/nix-test.yml"
  push:
    branches: [main]
    paths:
      - "flake.nix"
      - "flake.lock"
      - "package.nix"
      - "apps/desktop/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/nix-test.yml"
  workflow_dispatch:

jobs:
  update-hashes:
    name: Update Nix Hashes
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      hashes_updated: ${{ steps.update.outputs.updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Compute and update hashes
        id: update
        run: |
          set -euo pipefail
          UPDATED="false"
          
          # Install prefetch-npm-deps from nixpkgs
          echo "::group::Installing prefetch tools"
          nix profile install nixpkgs#prefetch-npm-deps
          echo "::endgroup::"
          
          # Compute pnpm hash using prefetch-npm-deps
          echo "::group::Computing pnpm hash"
          PNPM_HASH=$(prefetch-npm-deps pnpm-lock.yaml 2>/dev/null | tail -1 || echo "")
          CURRENT_PNPM_HASH=$(grep -oP 'pnpmHash = "\Ksha256-[^"]+' flake.nix || echo "")
          
          echo "Current pnpm hash: $CURRENT_PNPM_HASH"
          echo "Computed pnpm hash: $PNPM_HASH"
          
          if [ -n "$PNPM_HASH" ] && [ "$PNPM_HASH" != "$CURRENT_PNPM_HASH" ]; then
            echo "Updating pnpmHash..."
            sed -i "s|pnpmHash = \"[^\"]*\"|pnpmHash = \"$PNPM_HASH\"|g" flake.nix
            UPDATED="true"
          fi
          echo "::endgroup::"
          
          # Compute cargo hash using nix-prefetch
          echo "::group::Computing cargo hash"
          CARGO_TOML="apps/desktop/src-tauri/Cargo.toml"
          CARGO_LOCK="apps/desktop/src-tauri/Cargo.lock"
          
          if [ -f "$CARGO_LOCK" ]; then
            # Use nix to compute cargo vendor hash
            CARGO_HASH=$(nix run nixpkgs#nix-prefetch -- \
              '{ sha256 }: (import <nixpkgs> {}).rustPlatform.fetchCargoVendor { 
                src = ./apps/desktop/src-tauri; 
                hash = sha256;
              }' 2>/dev/null || echo "")
            
            if [ -z "$CARGO_HASH" ]; then
              # Fallback: try building and extract from error
              echo "Prefetch failed, trying build extraction..."
              CARGO_HASH=$(nix build .#nightly 2>&1 | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' | head -1 || echo "")
            fi
            
            CURRENT_CARGO_HASH=$(grep -oP 'cargoHash = "\Ksha256-[^"]+' flake.nix || echo "")
            
            echo "Current cargo hash: $CURRENT_CARGO_HASH"
            echo "Computed cargo hash: $CARGO_HASH"
            
            if [ -n "$CARGO_HASH" ] && [ "$CARGO_HASH" != "$CURRENT_CARGO_HASH" ]; then
              echo "Updating cargoHash..."
              sed -i "s|cargoHash = \"[^\"]*\"|cargoHash = \"$CARGO_HASH\"|g" flake.nix
              UPDATED="true"
            fi
          fi
          echo "::endgroup::"
          
          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          
          if [ "$UPDATED" = "true" ]; then
            echo "::notice::Hashes were updated"
            grep -E "(cargoHash|pnpmHash)" flake.nix
          fi

      - name: Commit and push updated hashes
        if: steps.update.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add flake.nix
          git diff --staged --quiet && exit 0
          
          git commit -m "chore(nix): update dependency hashes [skip ci]"
          git push

  check-flake:
    name: Check Flake
    runs-on: ubuntu-latest
    needs: [update-hashes]
    if: always() && (needs.update-hashes.result == 'success' || needs.update-hashes.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Check flake
        run: nix flake check --all-systems --show-trace

      - name: Show flake metadata
        run: nix flake metadata

  build-nightly:
    name: Build Nightly Package
    runs-on: ubuntu-latest
    needs: check-flake
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Build nightly package
        run: |
          nix build .#nightly --print-build-logs

      - name: Check binary
        run: |
          nix run .#nightly -- --version || true
          nix path-info .#nightly

      - name: Show package info
        run: |
          nix eval .#nightly.meta.description --json
          nix eval .#nightly.version --json || echo "Version info not available"

  build-dev-shell:
    name: Test Development Shell
    runs-on: ubuntu-latest
    needs: check-flake
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Build development shell
        run: |
          nix develop --command echo "Development shell loaded successfully"

      - name: Check dev tools availability
        run: |
          nix develop --command bash -c "
            echo 'Checking Rust toolchain...'
            rustc --version
            cargo --version

            echo 'Checking Node.js tools...'
            node --version
            pnpm --version
            bun --version

            echo 'Checking development tools...'
            biome --version || echo 'biome not in PATH'
            turbo --version
          "
